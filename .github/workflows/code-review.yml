name: PR Code Review with Ollama

# Trigger the workflow when a pull request is opened or updated
on:
  pull_request_target:
    branches:
      - main

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    env:
      MODEL_NAME: "llama3.2:latest"
    steps:
      # Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Checks out the code from the pull request's head branch.
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Fetch Pull Request Branch
        run: git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch

      - name: Generate Diff
        run: |
          set -e
          git diff $GITHUB_BASE_REF pr-branch > change.diff
          echo "Diff generated successfully."
          echo "Diff content:" $(cat change.diff)

      - name: Check Diff Size
        id: check_diff_size
        run: |
          set -e
          DIFF_SIZE=$(wc -c < change.diff)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT
          if (( DIFF_SIZE > 1000000 )); then
            echo "Diff is too large, skipping review."
            exit 0
          fi

      # - name: Install Ollama CLI
      #   run: |
      #     curl -fsSL https://ollama.com/install.sh | sh
      #     ollama --version
